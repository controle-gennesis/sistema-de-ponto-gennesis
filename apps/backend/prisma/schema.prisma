// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Modelo de Usuário
model User {
  id           String   @id @default(cuid())
  email        String   @unique
  password     String
  name         String
  cpf          String   @unique
  role         UserRole @default(EMPLOYEE)
  isActive     Boolean  @default(true)
  isFirstLogin Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos
  employee     Employee?
  timeRecords  TimeRecord[]
  vacations    Vacation[]
  overtime     Overtime[]
  reports      Report[]
  medicalCertificates MedicalCertificate[]
  approvedCertificates MedicalCertificate[] @relation("CertificateApprover")
  salaryAdjustments SalaryAdjustment[]
  salaryDiscounts   SalaryDiscount[]
  pointCorrectionRequests PointCorrectionRequest[] @relation("PointCorrectionApprover")
  pointCorrectionComments PointCorrectionComment[]
  sentMessages      Message[]                       @relation("MessageSender")
  initiatedChats    Chat[]                          @relation("ChatInitiator")
  acceptedChats     Chat[]                          @relation("ChatAccepter")
  closedChats       Chat[]                          @relation("ChatCloser")
  finalizedPayrolls PayrollStatus[]                 @relation("PayrollFinalizer")
  materialRequestsRequested MaterialRequest[]       @relation("MaterialRequestRequester")
  materialRequestsApproved  MaterialRequest[]       @relation("MaterialRequestApprover")
  materialRequestsRejected   MaterialRequest[]      @relation("MaterialRequestRejecter")
  chatGPTConversations      ChatGPTConversation[]
  passwordResetTokens PasswordResetToken[]
  purchaseOrdersCreated     PurchaseOrder[]        @relation("PurchaseOrderCreator")
  purchaseOrdersApproved    PurchaseOrder[]        @relation("PurchaseOrderApprover")

  @@map("users")
}

// Modelo de Funcionário
model Employee {
  id                String    @id @default(cuid())
  userId            String    @unique
  employeeId        String    @unique // Matrícula
  department        String
  position          String
  hireDate          DateTime
  birthDate         DateTime? // Data de nascimento para aniversários
  salary            Decimal   @db.Decimal(10, 2)
  workSchedule      Json      // Horário de trabalho em JSON
  isRemote          Boolean   @default(false)
  allowedLocations  Json?     // Locais permitidos para bater ponto
  costCenter        String?   // Centro de custo
  client            String?   // Tomador
  dailyFoodVoucher  Float?    @default(33.40) // Vale Alimentação diário (padrão R$ 33,40)
  dailyTransportVoucher Float? @default(11.00) // Vale Transporte diário (padrão R$ 11,00)
  
  // Novos campos - Dados da Empresa
  company           String?   // EMPRESA
  
  // Novos campos - Dados Bancários
  bank              String?   // BANCO
  accountType       String?   // TIPO DE CONTA
  agency            String?   // AGÊNCIA
  operation         String?   // OP.
  account           String?   // CONTA
  digit             String?   // DIGITO
  
  // Novos campos - Dados PIX
  pixKeyType        String?   // TIPO DE CHAVE
  pixKey            String?   // CHAVE PIX
  
  // Novos campos - Modalidade e Adicionais
  modality          String?   // MODALIDADE (MEI, CLT, ESTAGIARIO)
  familySalary      Decimal?  @db.Decimal(10, 2) // SALÁRIO FAMÍLIA
  dangerPay         Decimal?  @db.Decimal(10, 2) // PERICULOSIDADE
  unhealthyPay      Decimal?  @db.Decimal(10, 2) // INSALUBRIDADE
  
  // Novos campos - Polo e Categoria Financeira
  polo              String?   // POLO (BRASÍLIA, GOIÁS)
  categoriaFinanceira String?  // CATEGORIA FINANCEIRA (CUSTO, DESPESA)
  
  // Campo para controlar se o funcionário precisa bater ponto
  requiresTimeClock Boolean   @default(true) // Se false, não precisa bater ponto
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt

  // Relacionamentos
  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  timeRecords TimeRecord[]
  vacations   Vacation[]
  overtime    Overtime[]
  medicalCertificates MedicalCertificate[]
  salaryAdjustments SalaryAdjustment[]
  salaryDiscounts   SalaryDiscount[]
  pointCorrectionRequests PointCorrectionRequest[]
  manualInssValues   ManualInssValue[]

  @@map("employees")
}

// Modelo de Registro de Ponto
model TimeRecord {
  id          String        @id @default(cuid())
  userId      String
  employeeId  String
  type        TimeRecordType
  timestamp   DateTime      @default(now())
  latitude    Float?
  longitude   Float?
  photoUrl    String?
  photoKey    String?       // Chave do S3
  isValid     Boolean       @default(true)
  reason      String?       // Motivo se inválido
  observation String?       // Observação do funcionário
  approvedBy  String?       // ID do aprovador
  approvedAt  DateTime?
  foodVoucherAmount Float?  @default(0) // Valor do VA no dia
  transportVoucherAmount Float? @default(0) // Valor do VT no dia
  costCenter  String?       // Centro de custo do funcionário no momento do ponto
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relacionamentos
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("time_records")
}

// Modelo de Férias
model Vacation {
  id                    String         @id @default(cuid())
  userId               String
  employeeId           String
  
  // Período das férias
  startDate            DateTime
  endDate              DateTime
  days                 Int
  
  // Classificação
  type                 VacationType    @default(ANNUAL)
  status               VacationStatus  @default(PENDING)
  fraction             Int?            // Número do fracionamento (1, 2, 3)
  
  // Período aquisitivo
  aquisitiveStart      DateTime        // Início do período aquisitivo
  aquisitiveEnd        DateTime        // Fim do período aquisitivo
  concessiveEnd        DateTime        // Vencimento das férias
  
  // Documentação
  noticeSentAt         DateTime?       // Data do aviso
  noticeReceivedAt     DateTime?       // Data da confirmação
  paymentDate          DateTime?       // Data do pagamento
  paymentAmount        Decimal?        @db.Decimal(10, 2)
  
  // Aprovação
  reason               String?
  approvedBy           String?
  approvedAt           DateTime?
  
  // Auditoria
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt

  // Relacionamentos
  user                 User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  employee             Employee        @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("vacations")
}

// Modelo de Horas Extras
model Overtime {
  id          String        @id @default(cuid())
  userId      String
  employeeId  String
  date        DateTime
  hours       Decimal       @db.Decimal(4, 2)
  type        OvertimeType
  description String?
  status      OvertimeStatus @default(PENDING)
  approvedBy  String?
  approvedAt  DateTime?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relacionamentos
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  employee Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@map("overtime")
}

// Modelo de Relatórios
model Report {
  id          String     @id @default(cuid())
  userId      String
  type        ReportType
  title       String
  description String?
  data        Json       // Dados do relatório em JSON
  period      Json       // Período do relatório
  status      ReportStatus @default(GENERATED)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  // Relacionamentos
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("reports")
}

// Modelo de Configurações da Empresa
model CompanySettings {
  id                    String   @id @default(cuid())
  name                  String
  cnpj                  String   @unique
  address               String
  phone                 String?
  email                 String?
  workStartTime         String   @default("07:00")
  workEndTime           String   @default("17:00")
  lunchStartTime        String   @default("12:00")
  lunchEndTime          String   @default("13:00")
  toleranceMinutes      Int      @default(10)
  maxOvertimeHours      Int      @default(2)
  maxDistanceMeters     Int      @default(1000)
  defaultLatitude       Float    @default(-23.5505)
  defaultLongitude      Float    @default(-46.6333)
  vacationDaysPerYear   Int      @default(30)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  @@map("company_settings")
}

// Modelo de Logs de Auditoria
model AuditLog {
  id        String   @id @default(cuid())
  userId    String?
  action    String
  entity    String
  entityId  String?
  oldData   Json?
  newData   Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@map("audit_logs")
}

// Enums
enum UserRole {
  EMPLOYEE
}

enum TimeRecordType {
  ENTRY
  EXIT
  LUNCH_START
  LUNCH_END
  BREAK_START
  BREAK_END
  ABSENCE_JUSTIFIED
}

enum VacationType {
  ANNUAL               // Férias anuais
  FRACTIONED_1         // 1º período fracionado
  FRACTIONED_2         // 2º período fracionado  
  FRACTIONED_3         // 3º período fracionado
  SICK                 // Férias por doença
  MATERNITY            // Licença maternidade
  PATERNITY            // Licença paternidade
  EMERGENCY            // Férias de emergência
  COLLECTIVE           // Férias coletivas
}

enum VacationStatus {
  PENDING              // Aguardando aprovação
  APPROVED             // Aprovado
  NOTICE_SENT          // Aviso enviado
  NOTICE_CONFIRMED     // Aviso confirmado
  IN_PROGRESS          // Em andamento
  COMPLETED            // Concluído
  REJECTED             // Rejeitado
  CANCELLED            // Cancelado
  EXPIRED              // Vencido
}

enum OvertimeType {
  REGULAR
  WEEKEND
  HOLIDAY
  NIGHT
}

enum OvertimeStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum ReportType {
  ATTENDANCE
  OVERTIME
  VACATION
  PRODUCTIVITY
  CUSTOM
}

enum ReportStatus {
  GENERATED
  PROCESSING
  ERROR
}

// Modelo de Atestados Médicos
model MedicalCertificate {
  id              String                    @id @default(cuid())
  userId          String
  employeeId      String
  type            MedicalCertificateType    @default(MEDICAL)
  startDate       DateTime                  // Data de início (pode ser futura)
  endDate         DateTime                  // Data de fim (pode ser futura)
  days            Int                       // Quantidade de dias (calculado automaticamente)
  description     String?                   // Descrição/observações do funcionário
  fileName        String?                   // Nome do arquivo anexado
  fileUrl         String?                   // URL do arquivo no S3
  fileKey         String?                   // Chave do arquivo no S3
  status          MedicalCertificateStatus  @default(PENDING)
  reason          String?                   // Motivo da reprovação (se aplicável)
  approvedBy      String?                   // ID do RH que aprovou/reprovou
  approvedAt      DateTime?                 // Data da aprovação/reprovação
  submittedAt     DateTime                  @default(now()) // Data de envio
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  // Relacionamentos
  user            User                      @relation(fields: [userId], references: [id], onDelete: Cascade)
  employee        Employee                  @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approver        User?                     @relation("CertificateApprover", fields: [approvedBy], references: [id])

  @@map("medical_certificates")
}

enum MedicalCertificateType {
  MEDICAL        // Atestado médico
  DENTAL         // Atestado odontológico
  PREVENTIVE     // Atestado de exame preventivo
  ACCIDENT       // Atestado de acidente de trabalho
  COVID          // Atestado COVID-19
  MATERNITY      // Atestado de maternidade
  PATERNITY      // Atestado de paternidade
  OTHER          // Outros
}

enum MedicalCertificateStatus {
  PENDING        // Aguardando aprovação
  APPROVED       // Aprovado
  REJECTED       // Rejeitado
  CANCELLED      // Cancelado pelo funcionário
}

// Novos enums para os campos adicionados
enum Company {
  ABRASIL        // ABRASIL
  GENNESIS       // GÊNNESIS
  METRICA        // MÉTRICA
}

enum Bank {
  BANCO_DO_BRASIL    // BANCO DO BRASIL
  BRADESCO          // BRADESCO
  C6                // C6
  CAIXA_ECONOMICA   // CAIXA ECONÔMICA
  CEF               // CEF
  INTER             // INTER
  ITAU              // ITAÚ
  NUBANK            // NUBANK
  PICPAY            // PICPAY
  SANTANDER         // SANTANDER
}

enum AccountType {
  CONTA_SALARIO     // CONTA SALÁRIO
  CONTA_CORRENTE    // CONTA CORRENTE
  POUPANCA          // POUPANÇA
}

enum PixKeyType {
  ALEATORIA         // ALEATÓRIA
  CELULAR           // CELULAR
  CNPJ              // CNPJ
  CPF               // CPF
  EMAIL             // E-MAIL
}

// Modelo de Acréscimos Salariais
model SalaryAdjustment {
  id          String           @id @default(cuid())
  employeeId  String
  type        AdjustmentType
  description String
  amount      Decimal          @db.Decimal(10, 2)
  isFixed     Boolean          @default(false)  // Se true, será aplicado automaticamente todo mês
  createdBy   String
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  // Relacionamentos
  employee  Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  creator   User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("salary_adjustments")
}

enum AdjustmentType {
  BONUS        // Bônus/Prêmio
  OVERTIME     // Horas Extras
  COMMISSION   // Comissão
  OTHER        // Outros
}

// Modelo de Descontos Salariais
model SalaryDiscount {
  id          String        @id @default(cuid())
  employeeId  String
  type        DiscountType
  description String
  amount      Decimal       @db.Decimal(10, 2)
  createdBy   String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  // Relacionamentos
  employee  Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  creator   User     @relation(fields: [createdBy], references: [id], onDelete: Cascade)

  @@map("salary_discounts")
}

enum DiscountType {
  FINE        // Multa
  CONSIGNED   // Consignado
  OTHER       // Outros
}

// Modelo de Solicitações de Correção de Ponto
model PointCorrectionRequest {
  id               String            @id @default(cuid())
  employeeId       String
  title            String
  description      String
  justification    String
  
  // Dados originais (incorretos)
  originalDate     DateTime
  originalTime     String
  originalType     TimeRecordType
  
  // Dados corrigidos (solicitados)
  correctedDate    DateTime
  correctedTime    String
  correctedType    TimeRecordType
  
  // Status e aprovação
  status           RequestStatus     @default(PENDING)
  approvedBy       String?
  approvedAt       DateTime?
  rejectionReason  String?
  
  // Metadados
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt

  // Relacionamentos
  employee         Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  approver         User?             @relation("PointCorrectionApprover", fields: [approvedBy], references: [id])
  comments         PointCorrectionComment[]

  @@map("point_correction_requests")
}

// Modelo de Comentários das Solicitações
model PointCorrectionComment {
  id         String                 @id @default(cuid())
  requestId  String
  userId     String
  comment    String
  isInternal Boolean                @default(false)
  createdAt  DateTime               @default(now())

  // Relacionamentos
  request    PointCorrectionRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  user       User                   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("point_correction_comments")
}

// Modelo de Valores Manuais de INSS (Rescisão e 13°)
model ManualInssValue {
  id         String   @id @default(cuid())
  employeeId String
  month      Int      // Mês (1-12)
  year       Int      // Ano
  inssRescisao Decimal @default(0) // INSS RESCISÃO
  inss13     Decimal  @default(0)  // INSS 13°
  descontoPorFaltas Decimal? // Ajuste manual do desconto por faltas
  dsrPorFalta Decimal? // Ajuste manual do DSR por falta
  horasExtrasValue Decimal? // Ajuste manual do valor de horas extras
  dsrHEValue Decimal? // Ajuste manual do DSR por horas extras
  alocacaoFinal String? // Alocação final editável manualmente
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  // Relacionamentos
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  // Índice único para evitar duplicatas
  @@unique([employeeId, month, year])
  @@map("manual_inss_values")
}

enum RequestStatus {
  PENDING     // Pendente
  IN_REVIEW   // Em Análise
  APPROVED    // Aprovada
  REJECTED    // Rejeitada
  CANCELLED   // Cancelada
}

// Modelo de Feriados
model Holiday {
  id          String      @id @default(cuid())
  name        String      // Nome do feriado
  date        DateTime    // Data do feriado
  type        HolidayType @default(NATIONAL) // Tipo de feriado
  isRecurring Boolean     @default(false) // Se é recorrente (todos os anos)
  state       String?     // Estado (para feriados estaduais)
  city        String?     // Cidade (para feriados municipais)
  description String?     // Descrição adicional
  isActive    Boolean     @default(true) // Se está ativo
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  createdBy   String?     // ID do usuário que criou

  @@unique([date, name]) // Evita duplicatas
  @@index([date])
  @@index([type])
  @@index([isRecurring])
  @@map("holidays")
}

enum HolidayType {
  NATIONAL   // Feriado nacional
  STATE      // Feriado estadual
  MUNICIPAL  // Feriado municipal
  OPTIONAL   // Ponto facultativo
  COMPANY    // Feriado da empresa
}

// Modelo de Chat/Conversa entre Setores
model Chat {
  id                  String          @id @default(cuid())
  initiatorId         String          // Quem iniciou a conversa
  recipientDepartment String          // Setor destinatário
  status              ChatStatus      @default(PENDING) // PENDING, ACCEPTED, CLOSED
  acceptedBy          String?         // Quem aceitou a conversa
  acceptedAt          DateTime?       // Quando foi aceita
  closedBy            String?         // Quem encerrou
  closedAt            DateTime?       // Quando foi encerrada
  lastMessageAt       DateTime?       // Última mensagem enviada
  
  // Mensagens da conversa
  messages            Message[]
  
  // Relacionamentos
  initiator           User            @relation("ChatInitiator", fields: [initiatorId], references: [id], onDelete: Cascade)
  accepter            User?           @relation("ChatAccepter", fields: [acceptedBy], references: [id], onDelete: SetNull)
  closer              User?           @relation("ChatCloser", fields: [closedBy], references: [id], onDelete: SetNull)
  
  @@index([initiatorId])
  @@index([recipientDepartment])
  @@index([status])
  @@index([lastMessageAt])
  @@map("chats")
}

// Modelo de Mensagens dentro de um Chat
model Message {
  id              String            @id @default(cuid())
  chatId          String            // Chat ao qual pertence
  senderId        String            // Quem enviou
  content         String            // Conteúdo da mensagem
  isRead          Boolean           @default(false)
  readAt          DateTime?         // Quando foi lida
  
  // Anexos
  attachments     MessageAttachment[]
  
  // Auditoria
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relacionamentos
  chat            Chat              @relation(fields: [chatId], references: [id], onDelete: Cascade)
  sender          User              @relation("MessageSender", fields: [senderId], references: [id], onDelete: Cascade)
  
  @@index([chatId])
  @@index([senderId])
  @@index([isRead])
  @@index([createdAt])
  @@map("messages")
}

// Modelo de Anexos de Mensagens
model MessageAttachment {
  id          String    @id @default(cuid())
  messageId   String
  fileName    String    // Nome original do arquivo
  fileUrl     String?   // URL do arquivo no S3
  fileKey     String?   // Chave do arquivo no S3
  fileSize    Int?      // Tamanho em bytes
  mimeType    String?   // Tipo MIME do arquivo
  createdAt   DateTime  @default(now())
  
  // Relacionamento
  message     Message   @relation(fields: [messageId], references: [id], onDelete: Cascade)
  
  @@index([messageId])
  @@map("message_attachments")
}

enum ChatStatus {
  PENDING     // Aguardando aceitação
  ACCEPTED     // Aceito e ativo
  CLOSED       // Encerrado
}

// Modelo de Status da Folha de Pagamento
model PayrollStatus {
  id          String   @id @default(cuid())
  month       Int      // Mês (1-12)
  year        Int      // Ano
  isFinalized Boolean  @default(false) // Se a folha foi finalizada pelo DP
  finalizedBy String?  // ID do usuário que finalizou
  finalizedAt DateTime? // Data/hora da finalização
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  finalizedByUser User? @relation("PayrollFinalizer", fields: [finalizedBy], references: [id], onDelete: SetNull)

  // Índice único para mês/ano
  @@unique([month, year])
  @@index([month, year])
  @@index([isFinalized])
  @@map("payroll_status")
}

// Modelo de Centro de Custo de Engenharia
model CostCenter {
  id          String   @id @default(cuid())
  code        String   @unique // Código do centro de custo
  name        String   // Nome do centro de custo
  description String?  // Descrição adicional
  state       String?  // Estado (DF, GO, etc.)
  polo        String?  // Polo (BRASÍLIA, GOIÁS, etc.)
  company     String?  // Empresa (ABRASIL, GÊNNESIS, MÉTRICA, etc.)
  isActive    Boolean  @default(true) // Se está ativo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  engineeringMaterials EngineeringMaterial[]
  projects             Project[]
  materialRequests     MaterialRequest[]

  @@index([code])
  @@index([isActive])
  @@map("cost_centers")
}

// Modelo de Obra/Projeto
model Project {
  id          String   @id @default(cuid())
  code        String   @unique // Código da obra
  name        String   // Nome da obra
  description String?  // Descrição da obra
  costCenterId String  // Centro de custo associado
  status      ProjectStatus @default(ACTIVE) // Status da obra
  startDate   DateTime? // Data de início
  endDate     DateTime? // Data de término prevista
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  costCenter  CostCenter @relation(fields: [costCenterId], references: [id], onDelete: Restrict)
  materialRequests MaterialRequest[]

  @@index([code])
  @@index([costCenterId])
  @@index([status])
  @@index([isActive])
  @@map("projects")
}

enum ProjectStatus {
  ACTIVE      // Em andamento
  PLANNING    // Em planejamento
  SUSPENDED   // Suspensa
  COMPLETED   // Concluída
  CANCELLED   // Cancelada
}

// Modelo de Requisição de Material
model MaterialRequest {
  id          String   @id @default(cuid())
  requestNumber String @unique // Número da requisição (ex: REQ-2025-001)
  requestedBy  String  // ID do usuário que solicitou
  costCenterId String  // Centro de custo
  projectId    String? // Obra/Projeto (opcional)
  description  String? // Descrição/observações da requisição
  status       MaterialRequestStatus @default(PENDING) // Status da requisição
  priority     MaterialRequestPriority @default(MEDIUM) // Prioridade
  requestedAt  DateTime @default(now()) // Data da requisição
  approvedBy   String? // ID do aprovador (compras)
  approvedAt   DateTime? // Data de aprovação
  rejectedBy   String? // ID de quem rejeitou
  rejectedAt   DateTime? // Data de rejeição
  rejectionReason String? // Motivo da rejeição
  completedAt  DateTime? // Data de conclusão (quando todos os itens foram atendidos)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relacionamentos
  requester    User @relation("MaterialRequestRequester", fields: [requestedBy], references: [id], onDelete: Restrict)
  approver     User? @relation("MaterialRequestApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  rejecter     User? @relation("MaterialRequestRejecter", fields: [rejectedBy], references: [id], onDelete: SetNull)
  costCenter   CostCenter @relation(fields: [costCenterId], references: [id], onDelete: Restrict)
  project      Project? @relation(fields: [projectId], references: [id], onDelete: SetNull)
  items        MaterialRequestItem[]
  purchaseOrders PurchaseOrder[]

  @@index([requestNumber])
  @@index([requestedBy])
  @@index([costCenterId])
  @@index([projectId])
  @@index([status])
  @@index([requestedAt])
  @@map("material_requests")
}

enum MaterialRequestStatus {
  PENDING     // Pendente - Aguardando análise de compras
  IN_REVIEW   // Em análise - Compras está analisando
  APPROVED    // Aprovada - Compras aprovou e está processando
  PARTIALLY_FULFILLED // Parcialmente atendida - Alguns itens foram atendidos
  FULFILLED   // Atendida - Todos os itens foram atendidos
  REJECTED    // Rejeitada - Compras rejeitou a requisição
  CANCELLED   // Cancelada - Engenharia cancelou a requisição
}

enum MaterialRequestPriority {
  LOW         // Baixa
  MEDIUM      // Média
  HIGH        // Alta
  URGENT      // Urgente
}

// Modelo de Item da Requisição de Material
model MaterialRequestItem {
  id                String   @id @default(cuid())
  materialRequestId String   // ID da requisição
  materialId        String   // ID do material (EngineeringMaterial)
  quantity          Decimal  @db.Decimal(10, 2) // Quantidade solicitada
  unit              String   // Unidade de medida
  unitPrice         Decimal? @db.Decimal(12, 2) // Preço unitário no momento da requisição
  totalPrice        Decimal? @db.Decimal(12, 2) // Preço total (quantity * unitPrice)
  notes             String?  // Observações sobre o item
  status            MaterialRequestItemStatus @default(PENDING) // Status do item
  fulfilledQuantity Decimal? @db.Decimal(10, 2) // Quantidade já atendida
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relacionamentos
  materialRequest   MaterialRequest @relation(fields: [materialRequestId], references: [id], onDelete: Cascade)
  material          EngineeringMaterial @relation(fields: [materialId], references: [id], onDelete: Restrict)
  purchaseOrderItems PurchaseOrderItem[]

  @@index([materialRequestId])
  @@index([materialId])
  @@index([status])
  @@map("material_request_items")
}

enum MaterialRequestItemStatus {
  PENDING     // Pendente
  APPROVED    // Aprovado
  PURCHASED   // Comprado
  DELIVERED   // Entregue
  CANCELLED   // Cancelado
}

// Modelo de Fornecedor (estilo TOTVS RM)
model Supplier {
  id          String   @id @default(cuid())
  code        String   @unique // Código do fornecedor
  name        String   // Razão social / Nome
  cnpj        String?  @unique // CNPJ
  email       String?
  phone       String?
  address     String?
  city        String?
  state       String?  // UF
  zipCode     String?
  contactName String?  // Nome do contato
  notes       String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  purchaseOrders PurchaseOrder[]

  @@index([code])
  @@index([isActive])
  @@map("suppliers")
}

// Modelo de Ordem de Compra (OC - estilo TOTVS RM)
model PurchaseOrder {
  id                String   @id @default(cuid())
  orderNumber       String   @unique // Número da OC (ex: OC-2025-001)
  materialRequestId String?  // SC que originou (opcional)
  supplierId        String   // Fornecedor
  status            PurchaseOrderStatus @default(DRAFT)
  orderDate         DateTime @default(now())
  expectedDelivery  DateTime? // Data prevista de entrega
  deliveryAddress   String?  // Endereço de entrega
  notes             String?
  createdBy         String   // Usuário que criou
  approvedBy        String?  // Usuário que aprovou
  approvedAt        DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  materialRequest   MaterialRequest? @relation(fields: [materialRequestId], references: [id], onDelete: SetNull)
  supplier          Supplier @relation(fields: [supplierId], references: [id], onDelete: Restrict)
  creator           User @relation("PurchaseOrderCreator", fields: [createdBy], references: [id], onDelete: Restrict)
  approver          User? @relation("PurchaseOrderApprover", fields: [approvedBy], references: [id], onDelete: SetNull)
  items             PurchaseOrderItem[]

  @@index([orderNumber])
  @@index([materialRequestId])
  @@index([supplierId])
  @@index([status])
  @@index([orderDate])
  @@map("purchase_orders")
}

enum PurchaseOrderStatus {
  DRAFT       // Rascunho
  PENDING     // Pendente de aprovação
  APPROVED    // Aprovada
  SENT        // Enviada ao fornecedor
  PARTIALLY_RECEIVED  // Parcialmente recebida
  RECEIVED    // Totalmente recebida
  CANCELLED   // Cancelada
}

// Modelo de Item da Ordem de Compra
model PurchaseOrderItem {
  id                    String   @id @default(cuid())
  purchaseOrderId       String
  materialRequestItemId String?  // Item da SC que originou (opcional)
  materialId            String
  quantity              Decimal  @db.Decimal(10, 2)
  unit                  String
  unitPrice             Decimal  @db.Decimal(12, 2)
  totalPrice            Decimal  @db.Decimal(12, 2)
  notes                 String?
  receivedQuantity      Decimal? @db.Decimal(10, 2) @default(0) // Quantidade já recebida
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  purchaseOrder         PurchaseOrder @relation(fields: [purchaseOrderId], references: [id], onDelete: Cascade)
  materialRequestItem   MaterialRequestItem? @relation(fields: [materialRequestItemId], references: [id], onDelete: SetNull)
  material              EngineeringMaterial @relation(fields: [materialId], references: [id], onDelete: Restrict)

  @@index([purchaseOrderId])
  @@index([materialRequestItemId])
  @@index([materialId])
  @@map("purchase_order_items")
}

// Modelo de Categoria de Material
model MaterialCategory {
  id          String   @id @default(cuid())
  code        String   @unique // Código da categoria
  name        String   // Nome da categoria (ex: Materiais, Mão de Obra, Equipamentos, Serviços)
  description String?  // Descrição
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relacionamentos
  materials   EngineeringMaterial[]

  @@map("material_categories")
}

// Modelo de Natureza Orçamentária
model BudgetNature {
  id        String   @id @default(cuid())
  code      String?  @unique
  name      String
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([code])
  @@index([isActive])
  @@map("budget_natures")
}

// Modelo de Material de Engenharia (SINAPI)
model EngineeringMaterial {
  id                String   @id @default(cuid())
  sinapiCode        String   @unique // Código oficial do material no SINAPI
  name              String?  // Nome do material
  description       String   // Descrição completa do material
  unit              String   // Unidade de medida (kg, m, m², un, etc.)
  medianPrice       Decimal? @db.Decimal(12, 2) // Preço mediano atual do SINAPI
  state             String?  // Estado (UF) referente ao material
  referenceMonth    Int?     // Mês de referência (1-12)
  referenceYear     Int?     // Ano de referência
  categoryId        String?  // Categoria do material
  costCenterId      String?  // Centro de custo associado
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relacionamentos
  category          MaterialCategory? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  costCenter        CostCenter? @relation(fields: [costCenterId], references: [id], onDelete: SetNull)
  priceHistory      PriceHistory[]
  requestItems      MaterialRequestItem[]
  purchaseOrderItems PurchaseOrderItem[]

  @@index([sinapiCode])
  @@index([state])
  @@index([categoryId])
  @@index([costCenterId])
  @@index([isActive])
  @@map("engineering_materials")
}

// Modelo de Composição SINAPI (CPU - Composição de Preços Unitários)
model Composition {
  id                String   @id @default(cuid())
  sinapiCode        String   // Código oficial da composição no SINAPI
  description       String   // Descrição da composição
  unit              String   // Unidade de medida (m², m³, etc.)
  compositePrice    Decimal? @db.Decimal(12, 2) // Custo total (materiais + mão de obra + equipamentos)
  state             String?  // Estado (UF) referente
  referenceMonth    Int?     // Mês de referência (1-12)
  referenceYear     Int?     // Ano de referência
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relacionamentos
  priceHistory      PriceHistory[]

  @@index([sinapiCode])
  @@index([state])
  @@index([isActive])
  @@map("compositions")
}

// Modelo de Histórico de Preços
model PriceHistory {
  id            String   @id @default(cuid())
  materialId    String?  // ID do material (se aplicável)
  compositionId String?  // ID da composição (se aplicável)
  price         Decimal  @db.Decimal(12, 2) // Valor registrado
  referenceDate DateTime // Data de referência (mês/ano)
  source        String   @default("SINAPI") // Fonte (SINAPI, ou outro sistema)
  createdAt     DateTime @default(now())

  // Relacionamentos
  material      EngineeringMaterial? @relation(fields: [materialId], references: [id], onDelete: Cascade)
  composition   Composition? @relation(fields: [compositionId], references: [id], onDelete: Cascade)

  @@index([materialId])
  @@index([compositionId])
  @@index([referenceDate])
  @@map("price_history")
}

// Modelo de Material de Construção Civil
model ConstructionMaterial {
  id          String   @id @default(cuid())
  name        String   // Nome do material
  description String?  // Descrição do material
  unit        String   // Unidade de medida (kg, m, m², un, etc.)
  isActive    Boolean  @default(true) // Se está ativo
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([name])
  @@index([isActive])
  @@map("construction_materials")
}

// Modelo de Conversas com ChatGPT
model ChatGPTConversation {
  id        String            @id @default(cuid())
  userId    String            // Usuário que criou a conversa
  title     String            // Título da conversa (primeira mensagem)
  createdAt DateTime          @default(now())
  updatedAt DateTime          @updatedAt

  // Relacionamentos
  user      User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages  ChatGPTMessage[]

  @@index([userId])
  @@index([createdAt])
  @@map("chatgpt_conversations")
}

// Modelo de Mensagens do ChatGPT
model ChatGPTMessage {
  id             String              @id @default(cuid())
  conversationId String              // Conversa à qual pertence
  role           String              // 'user' ou 'assistant'
  content        String              // Conteúdo da mensagem
  createdAt      DateTime            @default(now())

  // Relacionamento
  conversation   ChatGPTConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@map("chatgpt_messages")
}

// Modelo para tokens de reset de senha
model PasswordResetToken {
  id        String   @id @default(cuid())
  userId    String
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relacionamentos
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId])
  @@map("password_reset_tokens")
}